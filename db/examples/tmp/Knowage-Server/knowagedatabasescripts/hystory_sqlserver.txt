Insert in this file the history of DB Schema, only for SQL Server
Every items must have:
- The Developer who has made the change
- The SQL script that updates the schema ( schema, index and FK )
- The Date

-- ##################################################################################################

-- 23.02.2015 Francesco Lucchi: removed SBI_DOSSIER_* tables.

-- 06.05.2016 Alessandro Portosa: Renamed HIBERNATE_SEQUENCES and its fields with lowercase. It must be lowercase for Unix compatibility

--09.05.2016 Giulio Gavardi
ALTER T

--10.06.2016 Antonella Giachino: add hierarchy_name, level and member_name in SBI_GEO_MAP
ALTER TABLE  SBI_GEO_MAPS ADD HIERARCHY_NAME VARCHAR(100);
ALTER TABLE  SBI_GEO_MAPS ADD LEVEL INTEGER;
ALTER TABLE  SBI_GEO_MAPS ADD MEMBER_NAME VARCHAR(100);

-- 15.6.2016 Antonella: deleted WORSKSHEET engine - clean db from its user func and engines
ALTER TABLE SBI_USER_FUNC NOCHECK CONSTRAINT ALL;
DELETE from SBI_USER_FUNC  where name = 'CreateWorksheetFromDatasetUserFunctionality';
ALTER TABLE SBI_USER_FUNC WITH CHECK CHECK CONSTRAINT ALL;

ALTER TABLE SBI_OBJECTS NOCHECK CONSTRAINT ALL;
DELETE FROM SBI_OBJECTS WHERE ENGINE_ID = (select engine_id from SBI_ENGINES  where name = 'Worksheet Engine');
ALTER TABLE SBI_OBJECTS WITH CHECK CHECK CONSTRAINT ALL;

ALTER TABLE SBI_ENGINES NOCHECK CONSTRAINT ALL;
DELETE from SBI_ENGINES  where name = 'Worksheet Engine';
ALTER TABLE SBI_ENGINES WITH CHECK CHECK CONSTRAINT ALL;

ALTER TABLE SBI_DOMAINS NOCHECK CONSTRAINT ALL;
DELETE from SBI_DOMAINS where value_cd = 'WORKSHEET';
ALTER TABLE SBI_DOMAINS WITH CHECK CHECK CONSTRAINT ALL;

sp_RENAME 'SBI_GEO_MAPS.LEVEL', 'NUM_LEVEL' , 'COLUMN';


CREATE TABLE SBI_WHATIF_WORKFLOW(
	ID INT,
    MODEL_ID INT,
    USER_ID INT,
    SEQUENCE INT,
    STATE VARCHAR(20),
    NOTES VARCHAR(100),
    INFO VARCHAR(100),
	USER_IN VARCHAR(100) NOT NULL,
	USER_UP VARCHAR(100) NULL,
	USER_DE VARCHAR(100) NULL,
	TIME_IN DATETIME NULL DEFAULT NULL,
	TIME_UP DATETIME NULL,
	TIME_DE DATETIME NULL,
	SBI_VERSION_IN VARCHAR(10) NULL,
	SBI_VERSION_UP VARCHAR(10) NULL,
	SBI_VERSION_DE VARCHAR(10) NULL,
	ORGANIZATION VARCHAR(20) NULL,
    PRIMARY KEY (ID)
);
ALTER TABLE SBI_WHATIF_WORKFLOW 				ADD CONSTRAINT FK_SBI_MODEL_WORKFLOW			FOREIGN KEY (MODEL_ID) 			REFERENCES SBI_ARTIFACTS(ID)	ON DELETE CASCADE ON UPDATE NO ACTION;
ALTER TABLE SBI_WHATIF_WORKFLOW 				ADD CONSTRAINT FK_SBI_USER_WORKFLOW			FOREIGN KEY (USER_ID) 				REFERENCES SBI_USER(ID) ON DELETE CASCADE ON UPDATE NO ACTION;

-- 09.08.2016 Alberto Ghedin: refactoring whatif start actions
update SBI_ENGINES set MAIN_URL="/knowagewhatifengine/restful-services/olap/startolap" where label = "knowageolapengine";
update SBI_ENGINES set MAIN_URL="/knowagewhatifengine/restful-services/olap/startwhatif" where label = "knowagewhatifengine";

-- 31.08.2016 Marco Cortella: changed foreign keys (delete policy) used by Business Model Catalog and Metadata import
ALTER TABLE SBI_META_TABLE_BC
	DROP CONSTRAINT FK_SBI_META_TABLE_BC_2;
ALTER TABLE SBI_META_TABLE_BC
	ADD CONSTRAINT FK_SBI_META_TABLE_BC_2 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON UPDATE NO ACTION ON DELETE CASCADE;

ALTER TABLE SBI_META_BC
	DROP CONSTRAINT FK_SBI_META_BC_1;
ALTER TABLE SBI_META_BC
	ADD CONSTRAINT FK_SBI_META_BC_1 FOREIGN KEY (MODEL_ID) REFERENCES SBI_META_MODELS (ID) ON UPDATE NO ACTION ON DELETE CASCADE;

ALTER TABLE SBI_META_BC_ATTRIBUTE
	DROP CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_1;
ALTER TABLE SBI_META_BC_ATTRIBUTE
	ADD CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_1 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON UPDATE NO ACTION ON DELETE CASCADE;

ALTER TABLE SBI_META_BC_ATTRIBUTE
	DROP CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_2;
ALTER TABLE SBI_META_BC_ATTRIBUTE
	ADD CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_2 FOREIGN KEY (COLUMN_ID) REFERENCES SBI_META_TABLE_COLUMN (COLUMN_ID) ON UPDATE NO ACTION ON DELETE CASCADE;

ALTER TABLE SBI_META_DS_BC
	DROP CONSTRAINT FK_SBI_META_DS_BC_2;
ALTER TABLE SBI_META_DS_BC
	ADD CONSTRAINT FK_SBI_META_DS_BC_2 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON UPDATE NO ACTION ON DELETE CASCADE;

-- 14.10.2016 S.Lupo: fixed numeric precision of threshold value
ALTER TABLE SBI_KPI_THRESHOLD_VALUE ALTER COLUMN MIN_VALUE FLOAT(53) NULL;
ALTER TABLE SBI_KPI_THRESHOLD_VALUE ALTER COLUMN MAX_VALUE FLOAT(53) NULL;

-- 7.11.2016 Giulio Gavardi
ALTER TABLE SBI_OUTPUT_PARAMETER ADD COLUMN IS_USER_DEFINED BIT NULL DEFAULT 0;

-- 30.11.2016 Ana Tomic
CREATE TABLE SBI_ACCESSIBILITY_PREFERENCES (
	 ID INT(11) UNSIGNED NOT NULL,
	 USER_ID INT(11) NOT NULL,
	 ENABLE_UIO TINYINT(1) NOT NULL,
	 ENABLE_RROBOBRAILLE TINYINT(1) NULL DEFAULT NULL,
	 ENABLE_GRAPH_SONIFICATION TINYINT(1) NULL DEFAULT NULL,
	 ENABLE_VOICE TINYINT(1) NULL DEFAULT NULL,
	 PREFERENCES TEXT NULL,
	 USER_IN VARCHAR(100) NULL DEFAULT NULL,
	 USER_UP VARCHAR(100) NULL DEFAULT NULL,
	 USER_DE VARCHAR(100) NULL DEFAULT NULL,
	 TIME_IN TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 TIME_UP TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 TIME_DE TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 SBI_VERSION_IN VARCHAR(10) NULL DEFAULT NULL,
	 SBI_VERSION_UP VARCHAR(10) NULL DEFAULT NULL,
	 SBI_VERSION_DE VARCHAR(10) NULL DEFAULT NULL,
	 ORGANIZATION VARCHAR(20) NULL DEFAULT NULL,
	INDEX FK_SBI_ACCESSIBILITY_PREFERENCES_SBI_USER (USER_ID),
	PRIMARY KEY (ID),
	CONSTRAINT FK_SBI_ACCESSIBILITY_PREFERENCES_SBI_USER FOREIGN KEY (USER_ID) REFERENCES SBI_USER (ID) ON UPDATE CASCADE ON DELETE CASCADE
);

-- 10.02.2017 ALberto Ghedin
-- added columns that link a snapshot with schedulation

ALTER TABLE SBI_SNAPSHOTS ADD COLUMN SCHEDULATION VARCHAR(100);
ALTER TABLE SBI_SNAPSHOTS ADD COLUMN SCHEDULER VARCHAR(100);
ALTER TABLE SBI_SNAPSHOTS ADD COLUMN SCHEDULATION_START INT;
ALTER TABLE SBI_SNAPSHOTS ADD COLUMN SEQUENCE INT;

-- 22.02.2017
-- added uniquiness constraint for kpi target

ALTER TABLE SBI_KPI_TARGET ADD CONSTRAINT XAK1SBI_KPI_TARGET UNIQUE (
	NAME,
	ORGANIZATION
);

-- 02.03.2017 Dragan Pirkovic
-- changed path for chart document execution
update SBI_ENGINES set MAIN_URL='/knowagecockpitengine/api/1.0/chart/pages/execute' where LABEL = 'knowagechartengine';
-- 20.03.2017 Marco Cortella
-- added TYPE column for SBI_CROSS_NAVIGATION
ALTER TABLE SBI_CROSS_NAVIGATION ADD COLUMN TYPE INT NOT NULL;

-- 09.06.2017 Alessandro Portosa
-- changed package for Alert actions
UPDATE SBI_ALERT_ACTION SET CLASS_NAME='it.eng.knowage.enterprise.tools.alert.action.ExecuteETLDocument' WHERE NAME = 'Execute ETL Document';
UPDATE SBI_ALERT_ACTION SET CLASS_NAME='it.eng.knowage.enterprise.tools.alert.action.SendMail' WHERE NAME = 'Send mail';

-- 13.07.2017 Francesco Lucchi
-- fix definition length, limiting varchars to 4000 (Oracle upper bound)
ALTER TABLE SBI_KPI_KPI ALTER COLUMN DEFINITION VARCHAR(4000) NOT NULL;
ALTER TABLE SBI_KPI_RULE ALTER COLUMN DEFINITION VARCHAR(4000) NOT NULL;
ALTER TABLE SBI_KPI_VALUE ALTER COLUMN LOGICAL_KEY VARCHAR(4000) NOT NULL;

-- 28.09.2017 Dragan Pirkovic
-- adding foreign key from sbi.metamodel.DATA_SOURCE_ID to sbi_data_source.DS_ID
ALTER TABLE SBI_META_MODELS ADD CONSTRAINT FK_META_MODELS_DS_ID FOREIGN KEY (DATA_SOURCE_ID) REFERENCES SBI_DATA_SOURCE(DS_ID) ON DELETE CASCADE ON UPDATE NO ACTION;

-- 05.10.2015 Alberto Ghedin removed mobile. The engine is not deleted because there can be some chart document in installation
delete from SBI_PRODUCT_TYPE_ENGINE where ENGINE_ID in(select ENGINE_ID from SBI_ENGINES where NAME='Mobile Chart Engine');
delete from SBI_PRODUCT_TYPE_ENGINE where ENGINE_ID in(select ENGINE_ID from SBI_ENGINES where NAME='Mobile Cockpit Engine');
delete from SBI_PRODUCT_TYPE_ENGINE where ENGINE_ID in(select ENGINE_ID from SBI_ENGINES where NAME='Mobile Report Engine');
delete from SBI_ENGINES where NAME='Mobile Chart Engine';
delete from SBI_ENGINES where NAME='Mobile Cockpit Engine';
delete from SBI_ENGINES where NAME='Mobile Report Engine';
delete from SBI_DOMAINS where VALUE_CD='MOBILE_CHART';
delete from SBI_DOMAINS where VALUE_CD='MOBILE_COCKPIT';
delete from SBI_DOMAINS where VALUE_CD='MOBILE_REPORT';
commit;

-- 11.10.2015 Alberto Ghedin added dossier
CREATE TABLE  SBI_DOSSIER_ACTIVITY(
		ID 					INT NOT NULL,
		PROGRESS 			INT NOT NULL,
		PPT					VARBINARY(MAX) NOT NULL,
	    DOCUMENT_ID 		INT,
	    ACTIVITY 			VARCHAR(45) NOT NULL,
	    PARAMS 				VARCHAR(4000),
	USER_IN VARCHAR(100) NOT NULL,
	USER_UP VARCHAR(100) NULL,
	USER_DE VARCHAR(100) NULL,
	TIME_IN DATETIME NULL DEFAULT NULL,
	TIME_UP DATETIME NULL,
	TIME_DE DATETIME NULL,
	SBI_VERSION_IN VARCHAR(10) NULL,
	SBI_VERSION_UP VARCHAR(10) NULL,
	SBI_VERSION_DE VARCHAR(10) NULL,
	ORGANIZATION VARCHAR(20) NULL,
	    PRIMARY KEY (ID)
);

ALTER TABLE SBI_DOSSIER_ACTIVITY ADD CONSTRAINT FK_SBI_PROGRESS_THREAD	FOREIGN KEY (PROGRESS) 	REFERENCES SBI_PROGRESS_THREAD(PROGRESS_THREAD_ID)			ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE SBI_DOSSIER_ACTIVITY ADD CONSTRAINT FK_SBI_OBJECTS FOREIGN KEY  (DOCUMENT_ID) REFERENCES SBI_OBJECTS (BIOBJ_ID) ON DELETE CASCADE ON UPDATE CASCADE;
--- 24.11.2017 Marco Cortella added Date type in domains for file dataset support
INSERT into SBI_DOMAINS (VALUE_ID, VALUE_CD, VALUE_NM, DOMAIN_CD, DOMAIN_NM,VALUE_DS, USER_IN) values ((SELECT next_val FROM hibernate_sequences WHERE sequence_name = 'SBI_DOMAINS'), 'Date', 'Date', 'DS_META_VALUE', 'Dataset Metadata Value', 'Dataset Metadata Value', '');
UPDATE hibernate_sequences SET next_val = (SELECT MAX(VALUE_ID) + 1 FROM SBI_DOMAINS) WHERE sequence_name = 'SBI_DOMAINS';

-- 13.03.2018 Giulio Gavardi
-- new column for roles , is_public
ALTER TABLE SBI_EXT_ROLES ADD COLUMN IS_PUBLIC BOOLEAN NULL;


-- 27.04.2018. Predrag Josipovic
-- Added new column into knowage.SBI_DATA_SOURCE table for Advanced JDBC Pool Configuration

ALTER TABLE SBI_DATA_SOURCE ADD JDBC_ADVANCED_CONFIGURATION	VARCHAR(4000);


-- 29.05.2018. Predrag Josipovic
-- Modifications on Knowage Metadata table SBI_I18N_MESSAGES, added new column ID as Primary Key

--- START ---
SP_RENAME 'SBI_I18N_MESSAGES', 'SBI_I18N_MESSAGES_OLD';

SELECT ROW_NUMBER() OVER(order by label) AS ID, t.* INTO SBI_I18N_MESSAGES FROM SBI_I18N_MESSAGES_OLD t;

DROP TABLE SBI_I18N_MESSAGES_OLD;

ALTER TABLE SBI_I18N_MESSAGES ADD CONSTRAINT PK_SBI_I18N_MESSAGES PRIMARY KEY (ID);
ALTER TABLE SBI_I18N_MESSAGES ADD CONSTRAINT FK_SBI_I18N_MESSAGES FOREIGN KEY (LANGUAGE_CD) REFERENCES SBI_DOMAINS (VALUE_ID);
ALTER TABLE SBI_I18N_MESSAGES ADD CONSTRAINT SBI_I18N_MESSAGES_UNIQUE UNIQUE (LANGUAGE_CD, LABEL, ORGANIZATION);

INSERT INTO hibernate_sequences VALUES ('SBI_I18N_MESSAGES',
                                                            (SELECT ISNULL(MAX(m.ID) + 1, 1) FROM SBI_I18N_MESSAGES m));
COMMIT;
--- END ---

-- 29.05.2018 Francesco Lucchi
ALTER TABLE SBI_DATA_SET ADD CONSTRAINT XAK2SBI_DATA_SET UNIQUE (NAME, VERSION_NUM, ORGANIZATION);

-- 01.06.2018 Giulio Gavardi

INSERT INTO SBI_CONFIG ( ID, LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID, CATEGORY, USER_IN, TIME_IN) VALUES
((SELECT next_val FROM hibernate_sequences WHERE sequence_name = 'SBI_CONFIG'),
'KNOWAGE.WORKSPACE_SHOW_GRID', 'Show grid view as default in workspace', 'Show grid view as default in workspace', true, 'true',
(select VALUE_ID from SBI_DOMAINS where VALUE_CD = 'STRING' AND DOMAIN_CD = 'PAR_TYPE'), 'GENERIC_CONFIGURATION', 'biadmin', current_timestamp);
update hibernate_sequences set next_val = next_val+1 where sequence_name = 'SBI_CONFIG';
commit;

-- 07.06.2018 Antonella Giachino
DELETE FROM SBI_PRODUCT_TYPE_ENGINE WHERE ENGINE_ID = (
    SELECT ENGINE_ID FROM SBI_ENGINES WHERE BIOBJ_TYPE = (
        SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'BIOBJ_TYPE' AND VALUE_CD = 'ACCESSIBLE_HTML'
    )
);

DELETE FROM SBI_ENGINES WHERE BIOBJ_TYPE = (
    SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'BIOBJ_TYPE' AND VALUE_CD = 'ACCESSIBLE_HTML'
);

DELETE FROM SBI_DOMAINS WHERE DOMAIN_CD = 'BIOBJ_TYPE' AND VALUE_CD = 'ACCESSIBLE_HTML';
COMMIT;

ALTER TABLE SBI_EVENTS_LOG ADD COLUMN EVENT_TYPE VARCHAR(50) DEFAULT 'SCHEDULER' NOT NULL;

UPDATE SBI_EVENTS_LOG SET EVENT_TYPE = (
CASE HANDLER
	WHEN 'it.eng.spagobi.events.handlers.DefaultEventPresentationHandler' THEN 'SCHEDULER'
	WHEN 'it.eng.spagobi.events.handlers.CommonjEventPresentationHandler' THEN 'COMMONJ'
	WHEN 'it.eng.spagobi.events.handlers.TalendEventPresentationHandler' THEN 'ETL'
	WHEN 'it.eng.spagobi.events.handlers.WekaEventPresentationHandler' THEN 'DATA_MINING'
END
);
commit;

ALTER TABLE SBI_EVENTS_LOG DROP COLUMN HANDLER;

-- 21.06.2018
ALTER TABLE SBI_OUTPUT_PARAMETER ALTER COLUMN FORMAT_VALUE VARCHAR(30);

-- 04.07.2018 Filip Milosavljevic

CREATE TABLE SBI_METAMODEL_PAR (
	METAMODEL_PAR_ID INT NOT NULL,
	PAR_ID INT NOT NULL,
	METAMODEL_ID INT NOT NULL,
	LABEL VARCHAR(40) NOT NULL,
	REQ_FL SMALLINT NULL,
	MOD_FL SMALLINT NULL,
	VIEW_FL SMALLINT NULL,
	MULT_FL SMALLINT NULL,
	PROG INT NOT NULL,
	PARURL_NM VARCHAR(20) NULL,
	PRIORITY INT NULL,
	COL_SPAN INT DEFAULT 1 NULL,
	THICK_PERC INT DEFAULT 0 NULL,
	USER_IN VARCHAR(100) NOT NULL,
	USER_UP VARCHAR(100) NULL,
	USER_DE VARCHAR(100) NULL,
	TIME_IN DATETIME NOT NULL,
	TIME_UP DATETIME NULL,
	TIME_DE DATETIME NULL,
	SBI_VERSION_IN VARCHAR(10) NULL,
	SBI_VERSION_UP VARCHAR(10) NULL,
	SBI_VERSION_DE VARCHAR(10) NULL,
	META_VERSION VARCHAR(100) NULL,
	ORGANIZATION VARCHAR(20) NULL,
	PRIMARY KEY (METAMODEL_PAR_ID)
);

ALTER TABLE SBI_METAMODEL_PAR ADD CONSTRAINT FK_SBI_METAMODEL_PAR_1 FOREIGN KEY (METAMODEL_ID) REFERENCES SBI_META_MODELS (ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE SBI_METAMODEL_PAR ADD CONSTRAINT FK_SBI_METAMODEL_PAR_2 FOREIGN KEY (PAR_ID) REFERENCES SBI_PARAMETERS (PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

CREATE TABLE SBI_METAMODEL_PARUSE (
	PARUSE_ID INT NOT NULL
	METAMODEL_PAR_ID INT NOT NULL,
	USE_ID INT NOT NULL,
	METAMODEL_PAR_FATHER_ID INT NOT NULL,
	FILTER_OPERATION VARCHAR(20) NOT NULL,
	PROG INT NOT NULL,
	FILTER_COLUMN VARCHAR(30) NOT NULL,
	PRE_CONDITION VARCHAR(10) NULL,
	POST_CONDITION VARCHAR(10) NULL,
	LOGIC_OPERATOR VARCHAR(10) NULL,
	USER_IN VARCHAR(100) NOT NULL,
	USER_UP VARCHAR(100) NULL,
	USER_DE VARCHAR(100) NULL,
	TIME_IN DATETIME NOT NULL,
	TIME_UP DATETIME NULL,
	TIME_DE DATETIME NULL,
	SBI_VERSION_IN VARCHAR(10) NULL,
	SBI_VERSION_UP VARCHAR(10) NULL,
	SBI_VERSION_DE VARCHAR(10) NULL,
	META_VERSION VARCHAR(100) NULL,
	ORGANIZATION VARCHAR(20) NULL,
	PRIMARY KEY (PARUSE_ID),
);

ALTER TABLE SBI_METAMODEL_PARUSE ADD CONSTRAINT FK_SBI_METAMODEL_PARUSE_1 FOREIGN KEY (METAMODEL_PAR_ID) REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE SBI_METAMODEL_PARUSE ADD CONSTRAINT FK_SBI_METAMODEL_PARUSE_2 FOREIGN KEY (USE_ID) REFERENCES SBI_PARUSE (USE_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE SBI_METAMODEL_PARUSE ADD CONSTRAINT FK_SBI_METAMODEL_PARUSE_3 FOREIGN KEY (METAMODEL_PAR_FATHER_ID) REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;


CREATE TABLE SBI_METAMODEL_PARVIEW (
	PARVIEW_ID INT NOT NULL,
	METAMODEL_PAR_ID INT NOT NULL,
	METAMODEL_PAR_FATHER_ID INT NOT NULL,
	OPERATION VARCHAR(20) NOT NULL,
	COMPARE_VALUE VARCHAR(200) NOT NULL,
	VIEW_LABEL VARCHAR(50) NULL,
	PROG INT NULL,
	USER_IN VARCHAR(100) NOT NULL,
	USER_UP VARCHAR(100) NULL,
	USER_DE VARCHAR(100) NULL,
	TIME_IN DATETIME NOT NULL,
	TIME_UP DATETIME NULL,
	TIME_DE DATETIME NULL,
	SBI_VERSION_IN VARCHAR(10) NULL,
	SBI_VERSION_UP VARCHAR(10) NULL,
	SBI_VERSION_DE VARCHAR(10) NULL,
	META_VERSION VARCHAR(100) NULL,
	ORGANIZATION VARCHAR(20) NULL,
	PRIMARY KEY (PARVIEW_ID),
);


ALTER TABLE SBI_METAMODEL_PARVIEW ADD CONSTRAINT FK_SBI_METAMODEL_PARVIEW_1 FOREIGN KEY (METAMODEL_PAR_ID) REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

ALTER TABLE SBI_METAMODEL_PARVIEW ADD CONSTRAINT FK_SBI_METAMODEL_PARVIEW_2 FOREIGN KEY (METAMODEL_PAR_FATHER_ID) REFERENCES SBI_METAMODEL_PAR (METAMODEL_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;
---END---

---Filip Milosavljevic 09.07.2018

ALTER TABLE SBI_METAMODEL_PAR
CHANGE COLUMN REQ_FL SMALLINT SET DEFAULT '0' ,
CHANGE COLUMN MOD_FL SMALLINT SET DEFAULT '0' ,
CHANGE COLUMN VIEW_FL SMALLINT SET DEFAULT '1' ,
CHANGE COLUMN MULT_FL SMALLINT SET DEFAULT '0' ;

ALTER TABLE SBI_OBJ_PAR
CHANGE COLUMN REQ_FL SMALLINT SET DEFAULT '0' ,
CHANGE COLUMN MOD_FL SMALLINT SET DEFAULT '0' ,
CHANGE COLUMN VIEW_FL SMALLINT SET DEFAULT '1' ,
CHANGE COLUMN MULT_FL SMALLINT SET DEFAULT '0' ;




---END---

--Dragan Pirkovic 09.07.2018---

ALTER TABLE SBI_FEDERATION_DEFINITION ADD COLUMN OWNER VARCHAR(100) NULL AFTER DEGENERATED;


--end--


-- 11.07.2018. Predrag Josipovic
-- STATEMENT START
DELETE FROM SBI_EXPORTERS WHERE ENGINE_ID IN (SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.qbe.QbeDriver')
AND
DOMAIN_ID IN (SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'EXPORT_TYPE' AND VALUE_CD IN ('PDF', 'RTF', 'JRXML', 'JSON'));

UPDATE SBI_EXPORTERS SET DEFAULT_VALUE = 1 WHERE ENGINE_ID IN (SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.qbe.QbeDriver')
AND
DOMAIN_ID IN (SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'EXPORT_TYPE' AND VALUE_CD = 'XLS');

commit;
-- STATEMENT END



-- 13.07.2018. Predrag Josipovic
-- STATEMENT START
ALTER TABLE SBI_DATA_SOURCE DROP CONSTRAINT XAK1SBI_DATA_SOURCE;

DROP INDEX IF EXISTS XAK1SBI_DATA_SOURCE;

ALTER TABLE SBI_DATA_SOURCE ADD CONSTRAINT XAK1SBI_DATA_SOURCE UNIQUE (LABEL);
-- STATEMENT END

---07.09.2018  Filip Milosavljevic---
--- STATEMENT START


SP_RENAME 'SBI_OBJ_PARUSE', 'SBI_OBJ_PARUSE_OLD';
SELECT ROW_NUMBER() OVER(order by OBJ_PAR_ID) AS PARUSE_ID, a.* INTO SBI_OBJ_PARUSE FROM SBI_OBJ_PARUSE_OLD a;
drop table SBI_OBJ_PARUSE_OLD;
alter table SBI_OBJ_PARUSE alter column PARUSE_ID int not null;
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT PK_PARUSE_ID PRIMARY KEY (PARUSE_ID);
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT FK_SBI_OBJ_PARUSE_1 FOREIGN KEY (OBJ_PAR_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT FK_SBI_OBJ_PARUSE_2 FOREIGN KEY (USE_ID) REFERENCES SBI_PARUSE (USE_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE SBI_OBJ_PARUSE ADD CONSTRAINT FK_SBI_OBJ_PARUSE_3 FOREIGN KEY (OBJ_PAR_FATHER_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

SP_RENAME 'SBI_OBJ_PARVIEW', 'SBI_OBJ_PARVIEW_OLD';
SELECT ROW_NUMBER() OVER(order by OBJ_PAR_ID) AS PARVIEW_ID, a.* INTO SBI_OBJ_PARVIEW FROM SBI_OBJ_PARVIEW_OLD a;
drop table SBI_OBJ_PARVIEW_OLD;
alter table SBI_OBJ_PARVIEW alter column PARVIEW_ID int not null;
ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT PK_PARVIEW_ID PRIMARY KEY (PARVIEW_ID);
ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT FK_SBI_OBJ_PARVIEW_1 FOREIGN KEY (OBJ_PAR_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;
ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT FK_SBI_OBJ_PARVIEW_2 FOREIGN KEY (OBJ_PAR_FATHER_ID) REFERENCES SBI_OBJ_PAR (OBJ_PAR_ID) ON UPDATE NO ACTION ON DELETE NO ACTION;

--- STATEMENT END

-- 07/09/2018 Antonella Giachino
DELETE FROM SBI_ROLE_TYPE_USER_FUNC WHERE ROLE_TYPE_ID = (SELECT VALUE_ID FROM SBI_DOMAINS WHERE VALUE_CD = 'TEST_ROLE') AND USER_FUNCT_ID IN (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC  WHERE  NAME IN ('TIMESPAN', 'FUNCTIONSCATALOGMANAGEMENT','MANAGECROSSNAVIGATION','EVENTSMANAGEMENT'));
COMMIT;

-- 14/12/2018 Davide Zerbetto
ALTER TABLE SBI_OBJECT_TEMPLATES ALTER COLUMN NAME VARCHAR(1000);

-- 16/01/2019 Antonella Giachino
ALTER TABLE SBI_CROSS_NAVIGATION ADD COLUMN DESCRIPTION VARCHAR(200) NULL DEFAULT NULL,
ALTER TABLE SBI_CROSS_NAVIGATION ADD COLUMN BREADCRUMB VARCHAR(200) NULL DEFAULT NULL;

-- 08/07/2019 Marco Libanori
ALTER TABLE SBI_USER ADD COLUMN FAILED_LOGIN_ATTEMPTS INT DEFAULT 0 NOT NULL AFTER DT_LAST_ACCESS;

-- 17/07/2019 Marco Libanori
ALTER TABLE SBI_PARUSE ADD COLUMN MAX_LOV_ID INT DEFAULT NULL AFTER DEFAULT_LOV_ID;
